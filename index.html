<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
	<title>GaiaTone</title>

	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
	
	<script src="build/Tone.min.js"></script>
	<script src="build/jquery.min.js"></script>
	<script src="scripts/StartAudioContext.js"></script>
	<script src="scripts/Interface.js"></script>

	<script src="./scripts/three.min.js"></script>
	<script src="./scripts/OrbitControls.js"></script>
	<script src="./scripts/WebGLDetector.js"></script>
	<script src="./scripts/THREE.Tone.js"></script>
	<script src="./scripts/draggabilly.js"></script>

	<script>
		// jshint ignore: start
	</script>

</head>
<body>	
	<div id="Content" class="FullScreen">
        <div id="controls"></div>
	</div>

	<script>
        function metallicity_to_modulation(metallicity) {
            // Fe/H effective range: -0.19, 0.04
            // beta range: 0.01 -> 100
            return Math.max(metallicity + 0.2, 0.00) * 30 + 0.01;
        }

        function temp_to_f0(temp) {
            // Teff range: 5165 -> 6575
            
            return Math.max(0, (temp - 5165) / (6575. - 5165) * 2000) + 32;
        }

        function logr_to_dip(logr) {
            // logr effective range: -0.15, 0.57
            //
            var dip = Math.max(logr + 0.15, 0) / (0.57 + 0.15);

            return 1 + dip;
        }
        var synths = [];
        var stellarData = []

        $.getJSON('beehive.json', function (data) {
            // Iterate over data, making synthesizers

            for (var i in data) {
                console.log(data[i])
                // data[i] = (T_eff, log(g), Fe/H)
                stellarData.push(data[i]);

                var beta = metallicity_to_modulation(data[i]['feh']);
                var f0 = temp_to_f0(data[i]['teff']);
                var dip = logr_to_dip(data[i]['log_r']);

                console.log('metallicity: ' + data[i]['feh'] + '  |  beta: ' + beta);
                console.log('teff:        ' + data[i]['teff'] + '  |  f0: ' + f0);
                console.log('log_r:       ' + data[i]['log_r'] + '  |  dip: ' + dip);

                // f0 from temperature
                var nsynth = new Tone.FMOscillator(f0, "sine", "square");

                // modulation index from metallicity
                nsynth.modulationIndex.value = beta;
                nsynth.harmonicity.value = 3;

                //nsynth.toMaster();
                //create an autofilter and start it's LFO
                var autoFilter = new Tone.AutoFilter(1 + Math.random(),
                                                     100,
                                                     dip).toMaster().start();
                nsynth.connect(autoFilter);

                synths.push(nsynth);

                // Add a control here too

                // Tone breaks if we add too many AutoFilters
                if (i > 100) {
                    break;
                }
            }
            //Tone.Transport.start();
        });
	</script>
</body>
</html>
