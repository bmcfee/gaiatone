<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
	<title>GaiaTone</title>

	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
	
	<script src="build/Tone.min.js"></script>
	<script src="build/jquery.min.js"></script>
	<script src="scripts/StartAudioContext.js"></script>
	<script src="scripts/Interface.js"></script>

	<script src="./scripts/three.min.js"></script>
	<script src="./scripts/OrbitControls.js"></script>
	<script src="./scripts/WebGLDetector.js"></script>
	<script src="./scripts/THREE.Tone.js"></script>
	<script src="./scripts/draggabilly.js"></script>

	<script>
		// jshint ignore: start
	</script>

	<link rel="stylesheet" type="text/css" href="css/examples.css">
</head>
<body>	

    <style type="text/css">
		#three {
			width: 100%;
			height: 600px;
		}
	</style>

	<div id="Content" class="FullScreen">
        <div id="three"></div>
        <div id="controls"></div>
	</div>

	<script>
        function allStart(max) {
            max = max || synths.length;
            for (var i in synths) {
                if (i > max) {
                    break;
                }
                synths[i].start();
            }
        }
        function allStop() {
            for (var i in synths) {
                synths[i].stop();
            }
        }
        function metallicity_to_modulation(metallicity) {
            // Fe/H effective range: -0.19, 0.04
            // beta range: 0.01 -> 100
            return Math.max(metallicity + 0.2, 0.00) * 100 + 0.01;
        }

        function temp_to_f0(temp) {
            // Teff range: 5165 -> 6575
            
            return Math.max(0, (temp - 5165) / (6575. - 5165)) * 500 + 16;
        }

        function logr_to_dip(logr) {
            // logr effective range: -0.15, 0.57
            //
            var dip = Math.max(logr + 0.15, 0) / (0.57 + 0.15);

            return 1 + dip;
        }
        var synths = [];
        var stellarData = []

        $.getJSON('beehive.json', function (data) {
            // Iterate over data, making synthesizers

            for (var i in data) {
                // Tone breaks if we add too many components :(
                if (i > 30) {
                    break;
                }

                console.log(data[i])
                // data[i] = (T_eff, log(g), Fe/H)
                stellarData.push(data[i]);

                var beta = metallicity_to_modulation(data[i]['feh']);
                var f0 = temp_to_f0(data[i]['teff']);
                var dip = logr_to_dip(data[i]['log_r']);

                console.log('metallicity: ' + data[i]['feh'] + '  |  beta: ' + beta);
                console.log('teff:        ' + data[i]['teff'] + '  |  f0: ' + f0);
                console.log('log_r:       ' + data[i]['log_r'] + '  |  dip: ' + dip);

                // f0 from temperature
                var nsynth = new Tone.FMOscillator(f0, "sine", "square");

                // modulation index from metallicity
                nsynth.modulationIndex.value = beta;
                nsynth.harmonicity.value = 3;

                //nsynth.toMaster();
                //create an autofilter and start it's LFO
                var autoFilter = new Tone.AutoFilter(1 + Math.random(),
                                                     100,
                                                     dip).start();
                nsynth.sync();
                nsynth.connect(autoFilter);

                var x = (data[i]['x'] + 0.1127) * 5000;
                var y = (data[i]['y'] - 0.1333) * 5000;
                var z = (data[i]['z'] - 0.0624) * 1000;

                var spatial = new Tone.Panner3D(x, y, z).toMaster();

                spatial.distanceModel = 'exponential';
                console.log(i, spatial.positionX, spatial.positionY, spatial.positionZ);
                autoFilter.connect(spatial);

                // Add the star to the scene

                var geometry = new THREE.SphereBufferGeometry( 1, 3, 2 );
                var material = new THREE.MeshBasicMaterial( {color: 0xffff00} );
                var sphere = new THREE.Mesh( geometry, material );
                sphere.position.x = x;
                sphere.position.y = y;
                sphere.position.z = z;
                console.log(sphere)
                scene.add( sphere );

                synths.push(nsynth);

            }
            Tone.Transport.start();
            console.log(scene);
        });
	</script>

    <script id="GUI">
		Interface.Button({
			key : 32,
			type : "toggle",
			text : "Start Sound (spacebar)",
			activeText : "Stop (spacebar)",
			start : function(){
                allStart(15);
			},
			end : function(){
                allStop();
			}
		});
		// THREE.JS //
	
		if (Detector.webgl) {
			var SCREEN_WIDTH = document.querySelector("#three").clientWidth;
			var SCREEN_HEIGHT = document.querySelector("#three").clientHeight;
			var aspect = SCREEN_WIDTH / SCREEN_HEIGHT;
			var scene = new THREE.Scene()
			var camera = new THREE.PerspectiveCamera( 50, aspect, 1, 10000 );

			//camera.position.z = 1;
            camera.position.x = -100;
            camera.position.y = 450;
            camera.position.z = 5;
			camera.updateMatrixWorld();

            if (0) {
                var bassMesh = new THREE.Mesh(
                    new THREE.SphereBufferGeometry( 2, 16, 8 ),
                    new THREE.MeshBasicMaterial( { color: 0xffffff, wireframe: true } )
                );
                scene.add(bassMesh);
                bassMesh.position.z = -10

                var dronMesh = new THREE.Mesh(
                    new THREE.SphereBufferGeometry( 1, 16, 8 ),
                    new THREE.MeshBasicMaterial( { color: 0xff0000, wireframe: true } )
                );
                scene.add(dronMesh);
                
                var chordMesh = new THREE.Mesh(
                    new THREE.SphereBufferGeometry( 1, 16, 8 ),
                    new THREE.MeshBasicMaterial( { color: 0xff00ff, wireframe: true } )
                );
                scene.add(chordMesh);
            }

			var renderer = new THREE.WebGLRenderer( { antialias: true } );
			
            renderer.setPixelRatio( window.devicePixelRatio );
			
			
            renderer.domElement.style.position = "relative";
			
            document.querySelector("#three").appendChild( renderer.domElement );

			controls = new THREE.OrbitControls( camera, renderer.domElement );
			
            controls.addEventListener("change", function(){
				Tone.Listener.updatePosition(camera);
                })
			
            //set the camera initially
			Tone.Listener.updatePosition(camera);

			function onWindowResize( event ) {
				SCREEN_WIDTH = document.querySelector("#three").clientWidth;
				SCREEN_HEIGHT = document.querySelector("#three").clientHeight;
				aspect = SCREEN_WIDTH / SCREEN_HEIGHT;
				camera.aspect = aspect;
				renderer.setSize( SCREEN_WIDTH, SCREEN_HEIGHT );
				camera.updateProjectionMatrix();
			}

            onWindowResize();
			
            window.addEventListener("resize", onWindowResize);
            function animate() {
                requestAnimationFrame( animate );
                var r = Date.now() * 0.0005;
                
                //chordMesh.position.x = 3 * Math.cos( r );
                //chordMesh.position.z = 3 * Math.cos( r );
                //chordMesh.position.y = 3 * Math.sin( r );
                //dronMesh.position.x = 4 * Math.cos( 2 * r );
                //dronMesh.position.z = 4 * Math.sin( 2 * r );
                renderer.render( scene, camera );
                controls.update();

                //greenSphere.updatePosition(dronMesh);
                //blueSphere.updatePosition(bassMesh);
                //whiteSphere.updatePosition(chordMesh);
            }
            animate()
		}
	</script>
</body>
</html>
